<div class="min-h-screen bg-slate-50 dark:bg-slate-900 p-4 md:p-6 lg:p-8">
  <!-- Header -->
  <div class="mb-6">
    <h1 class="text-3xl md:text-4xl font-bold text-slate-800 dark:text-white mb-2">
      Panel de Control
    </h1>
    <p class="text-slate-600 dark:text-slate-400">
      Análisis integral de operaciones - Sergeva S.A.
    </p>
  </div>

  <!-- Filtros -->
  <app-dashboard-filters
    (filtersChange)="onFiltersChange($event)"
    class="block mb-6">
  </app-dashboard-filters>

  <!-- Loading State -->
  @if (isLoading()) {
    <div class="flex items-center justify-center h-64">
      <div class="animate-spin rounded-full h-16 w-16 border-t-2 border-b-2 border-primary-600"></div>
    </div>
  }

  <!-- KPI Cards -->
  @if (!isLoading()) {
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-6">
      <app-kpi-card
        title="Total Órdenes de Trabajo"
        [value]="kpiData().totalOT"
        format="number"
        icon="orders"
        color="blue">
      </app-kpi-card>

      <app-kpi-card
        title="Ingresos Totales"
        [value]="kpiData().ingresosTotal"
        suffix="USD"
        format="currency"
        icon="money"
        color="green">
      </app-kpi-card>

      <app-kpi-card
        title="Horas Trabajadas"
        [value]="kpiData().horasTotales"
        suffix="hrs"
        format="number"
        icon="time"
        color="orange">
      </app-kpi-card>

      <app-kpi-card
        title="Tasa de Asistencia"
        [value]="kpiData().tasaAsistencia"
        suffix="%"
        format="percent"
        icon="people"
        color="purple">
      </app-kpi-card>

      <app-kpi-card
        title="Proyectos a Tiempo"
        [value]="kpiData().proyectosATiempo"
        suffix="%"
        format="percent"
        icon="check"
        color="green">
      </app-kpi-card>

      <app-kpi-card
        title="Desviación de Costos"
        [value]="kpiData().desviacionCostos"
        suffix="%"
        format="percent"
        icon="chart"
        color="red">
      </app-kpi-card>
    </div>

    <!-- Gráficos de Pastel -->
    <div class="mb-6">
      <h2 class="text-2xl font-bold text-slate-800 dark:text-white mb-4">
        Distribución y Estado
      </h2>
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
        <!-- Estado de OT -->
        <div class="bg-white dark:bg-slate-800 rounded-lg shadow-lg p-6">
          <h3 class="text-lg font-semibold text-slate-800 dark:text-white mb-4">
            Estado de Órdenes de Trabajo
          </h3>
          @if (estadoOTChart()) {
            <app-pie-chart
              [labels]="estadoOTChart()!.labels"
              [data]="estadoOTChart()!.data"
              [backgroundColor]="estadoOTChart()!.backgroundColor"
              [height]="300">
            </app-pie-chart>
          }
        </div>

        <!-- Personal por Especialidad -->
        <div class="bg-white dark:bg-slate-800 rounded-lg shadow-lg p-6">
          <h3 class="text-lg font-semibold text-slate-800 dark:text-white mb-4">
            Personal por Especialidad
          </h3>
          @if (personalEspecialidadChart()) {
            <app-pie-chart
              [labels]="personalEspecialidadChart()!.labels"
              [data]="personalEspecialidadChart()!.data"
              [backgroundColor]="personalEspecialidadChart()!.backgroundColor"
              [height]="300">
            </app-pie-chart>
          }
        </div>

        <!-- Consumo de Materiales -->
        <div class="bg-white dark:bg-slate-800 rounded-lg shadow-lg p-6">
          <h3 class="text-lg font-semibold text-slate-800 dark:text-white mb-4">
            Consumo de Materiales
          </h3>
          @if (consumoMaterialesChart()) {
            <app-pie-chart
              [labels]="consumoMaterialesChart()!.labels"
              [data]="consumoMaterialesChart()!.data"
              [backgroundColor]="consumoMaterialesChart()!.backgroundColor"
              [height]="300">
            </app-pie-chart>
          }
        </div>

        <!-- Asistencia -->
        <div class="bg-white dark:bg-slate-800 rounded-lg shadow-lg p-6">
          <h3 class="text-lg font-semibold text-slate-800 dark:text-white mb-4">
            Estado de Asistencia
          </h3>
          @if (asistenciaChart()) {
            <app-pie-chart
              [labels]="asistenciaChart()!.labels"
              [data]="asistenciaChart()!.data"
              [backgroundColor]="asistenciaChart()!.backgroundColor"
              [height]="300">
            </app-pie-chart>
          }
        </div>
      </div>
    </div>

    <!-- Gráficos de Barras - Primera Fila -->
    <div class="mb-6">
      <h2 class="text-2xl font-bold text-slate-800 dark:text-white mb-4">
        Análisis Comparativo
      </h2>
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
        <!-- Progreso de Proyectos -->
        <div class="bg-white dark:bg-slate-800 rounded-lg shadow-lg p-6">
          <h3 class="text-lg font-semibold text-slate-800 dark:text-white mb-4">
            Progreso de Proyectos
          </h3>
          @if (progresoProyectosChart()) {
            <app-bar-chart
              [labels]="progresoProyectosChart()!.labels"
              [datasets]="getBarDatasets(progresoProyectosChart())"
              [height]="300">
            </app-bar-chart>
          }
        </div>

        <!-- Horas por Proyecto -->
        <div class="bg-white dark:bg-slate-800 rounded-lg shadow-lg p-6">
          <h3 class="text-lg font-semibold text-slate-800 dark:text-white mb-4">
            Horas: Presupuestadas vs Reales
          </h3>
          @if (horasProyectoChart()) {
            <app-bar-chart
              [labels]="horasProyectoChart()!.labels"
              [datasets]="getMultipleBarDatasets(horasProyectoChart())"
              [height]="300">
            </app-bar-chart>
          }
        </div>

        <!-- Valor de Materiales -->
        <div class="bg-white dark:bg-slate-800 rounded-lg shadow-lg p-6">
          <h3 class="text-lg font-semibold text-slate-800 dark:text-white mb-4">
            Valor de Materiales por Proyecto
          </h3>
          @if (valorMaterialesChart()) {
            <app-bar-chart
              [labels]="valorMaterialesChart()!.labels"
              [datasets]="getBarDatasets(valorMaterialesChart())"
              [height]="300">
            </app-bar-chart>
          }
        </div>

        <!-- Asistencia Semanal -->
        <div class="bg-white dark:bg-slate-800 rounded-lg shadow-lg p-6">
          <h3 class="text-lg font-semibold text-slate-800 dark:text-white mb-4">
            Asistencia Semanal
          </h3>
          @if (asistenciaSemanalChart()) {
            <app-bar-chart
              [labels]="asistenciaSemanalChart()!.labels"
              [datasets]="getMultipleBarDatasets(asistenciaSemanalChart())"
              [stacked]="true"
              [height]="300">
            </app-bar-chart>
          }
        </div>
      </div>
    </div>

    <!-- Gráficos de Barras - Segunda Fila -->
    <div class="mb-6">
      <h2 class="text-2xl font-bold text-slate-800 dark:text-white mb-4">
        Indicadores de Gestión
      </h2>
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
        <!-- Valoración Económica -->
        <div class="bg-white dark:bg-slate-800 rounded-lg shadow-lg p-6">
          <h3 class="text-lg font-semibold text-slate-800 dark:text-white mb-4">
            Valoración Económica de Proyectos
          </h3>
          @if (valoracionEconomicaChart()) {
            <app-bar-chart
              [labels]="valoracionEconomicaChart()!.labels"
              [datasets]="getBarDatasets(valoracionEconomicaChart())"
              [height]="300">
            </app-bar-chart>
          }
        </div>

        <!-- OT Completadas Mensual -->
        <div class="bg-white dark:bg-slate-800 rounded-lg shadow-lg p-6">
          <h3 class="text-lg font-semibold text-slate-800 dark:text-white mb-4">
            OT Completadas por Mes
          </h3>
          @if (otCompletadasChart()) {
            <app-bar-chart
              [labels]="otCompletadasChart()!.labels"
              [datasets]="getBarDatasets(otCompletadasChart())"
              [height]="300">
            </app-bar-chart>
          }
        </div>

        <!-- Stock Crítico -->
        <div class="bg-white dark:bg-slate-800 rounded-lg shadow-lg p-6">
          <h3 class="text-lg font-semibold text-slate-800 dark:text-white mb-4">
            Productos con Stock Crítico
          </h3>
          @if (stockCriticoChart()) {
            <app-bar-chart
              [labels]="stockCriticoChart()!.labels"
              [datasets]="getBarDatasets(stockCriticoChart())"
              [horizontal]="true"
              [height]="300">
            </app-bar-chart>
          }
        </div>

        <!-- Costos de Proyectos -->
        <div class="bg-white dark:bg-slate-800 rounded-lg shadow-lg p-6">
          <h3 class="text-lg font-semibold text-slate-800 dark:text-white mb-4">
            Costos: Presupuestados vs Reales
          </h3>
          @if (costosProyectosChart()) {
            <app-bar-chart
              [labels]="costosProyectosChart()!.labels"
              [datasets]="getMultipleBarDatasets(costosProyectosChart())"
              [height]="300">
            </app-bar-chart>
          }
        </div>
      </div>
    </div>

    <!-- Tablas de Datos -->
    <div class="mb-6">
      <h2 class="text-2xl font-bold text-slate-800 dark:text-white mb-4">
        Detalle de Proyectos y Personal
      </h2>
      
      <!-- Tabla de Proyectos -->
      <div class="bg-white dark:bg-slate-800 rounded-lg shadow-lg p-6 mb-4">
        <h3 class="text-lg font-semibold text-slate-800 dark:text-white mb-4">
          Resumen de Proyectos
        </h3>
        <div class="overflow-x-auto">
          <table class="w-full text-sm text-left">
            <thead class="text-xs uppercase bg-slate-100 dark:bg-slate-700">
              <tr>
                <th class="px-4 py-3">Proyecto</th>
                <th class="px-4 py-3">Cliente</th>
                <th class="px-4 py-3 text-right">Horas Pres.</th>
                <th class="px-4 py-3 text-right">Horas Reales</th>
                <th class="px-4 py-3 text-right">Varianza</th>
                <th class="px-4 py-3 text-right">Costo Pres.</th>
                <th class="px-4 py-3 text-right">Costo Real</th>
                <th class="px-4 py-3 text-center">Estado</th>
              </tr>
            </thead>
            <tbody>
              @for (proyecto of tablaProyectos(); track proyecto.id) {
                <tr class="border-b dark:border-slate-700 hover:bg-slate-50 dark:hover:bg-slate-700">
                  <td class="px-4 py-3 font-medium">{{ proyecto.nombre }}</td>
                  <td class="px-4 py-3">{{ proyecto.cliente }}</td>
                  <td class="px-4 py-3 text-right">{{ proyecto.horas_presupuestadas }}</td>
                  <td class="px-4 py-3 text-right">{{ proyecto.horas_reales }}</td>
                  <td class="px-4 py-3 text-right" 
                      [class.text-green-600]="proyecto.varianza_horas <= 0"
                      [class.text-red-600]="proyecto.varianza_horas > 0">
                    {{ proyecto.varianza_horas > 0 ? '+' : '' }}{{ proyecto.varianza_horas }}%
                  </td>
                  <td class="px-4 py-3 text-right">${{ proyecto.costo_presupuestado | number:'1.2-2' }}</td>
                  <td class="px-4 py-3 text-right">${{ proyecto.costo_real | number:'1.2-2' }}</td>
                  <td class="px-4 py-3 text-center">
                    <span class="px-2 py-1 rounded-full text-xs"
                          [class]="proyecto.estado === 'completada' ? 'bg-green-100 text-green-800' :
                                   proyecto.estado === 'en_proceso' ? 'bg-blue-100 text-blue-800' :
                                   'bg-yellow-100 text-yellow-800'">
                      {{ proyecto.estado }}
                    </span>
                  </td>
                </tr>
              }
              @if (tablaProyectos().length === 0) {
                <tr>
                  <td colspan="8" class="px-4 py-8 text-center text-slate-500">
                    No hay proyectos para mostrar
                  </td>
                </tr>
              }
            </tbody>
          </table>
        </div>
      </div>

      <!-- Tabla de Personal -->
      <div class="bg-white dark:bg-slate-800 rounded-lg shadow-lg p-6">
        <h3 class="text-lg font-semibold text-slate-800 dark:text-white mb-4">
          Resumen de Personal
        </h3>
        <div class="overflow-x-auto">
          <table class="w-full text-sm text-left">
            <thead class="text-xs uppercase bg-slate-100 dark:bg-slate-700">
              <tr>
                <th class="px-4 py-3">Nombre</th>
                <th class="px-4 py-3">Especialidad</th>
                <th class="px-4 py-3 text-right">Horas Trabajadas</th>
                <th class="px-4 py-3 text-right">Proyectos Asignados</th>
                <th class="px-4 py-3 text-right">Tasa Asistencia</th>
                <th class="px-4 py-3 text-center">Estado</th>
              </tr>
            </thead>
            <tbody>
              @for (trabajador of tablaPersonal(); track trabajador.id) {
                <tr class="border-b dark:border-slate-700 hover:bg-slate-50 dark:hover:bg-slate-700">
                  <td class="px-4 py-3 font-medium">{{ trabajador.nombre }}</td>
                  <td class="px-4 py-3">{{ trabajador.especialidad }}</td>
                  <td class="px-4 py-3 text-right">{{ trabajador.horas_trabajadas }}</td>
                  <td class="px-4 py-3 text-right">{{ trabajador.proyectos_asignados }}</td>
                  <td class="px-4 py-3 text-right">{{ trabajador.tasa_asistencia }}%</td>
                  <td class="px-4 py-3 text-center">
                    <span class="px-2 py-1 rounded-full text-xs"
                          [class]="trabajador.estado === 'activo' ? 'bg-green-100 text-green-800' :
                                   trabajador.estado === 'inactivo' ? 'bg-slate-100 text-slate-800' :
                                   'bg-red-100 text-red-800'">
                      {{ trabajador.estado }}
                    </span>
                  </td>
                </tr>
              }
              @if (tablaPersonal().length === 0) {
                <tr>
                  <td colspan="6" class="px-4 py-8 text-center text-slate-500">
                    No hay personal para mostrar
                  </td>
                </tr>
              }
            </tbody>
          </table>
        </div>
      </div>
    </div>
  }
</div>
