<div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 gap-4">
  <h1 class="text-3xl font-semibold text-gray-800 dark:text-gray-100">Archivo por Cliente y Documentos</h1>
  @if (dbService.connected()) {
  <div class="flex space-x-2">
    @if (isAdmin()) {


    <button (click)="exportToCsv()" [disabled]="!clients().length"
      class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 flex items-center disabled:bg-slate-400 disabled:cursor-not-allowed">
      <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"
        xmlns="http://www.w3.org/2000/svg">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
          d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
      </svg>
      Exportar a Excel
    </button>


    }
    <button (click)="abrirModalNuevoCliente()"
      class="px-4 py-2 bg-primary-600 text-white rounded-md hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500 flex items-center">
      <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"
        xmlns="http://www.w3.org/2000/svg">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
      </svg>
      Añadir Cliente
    </button>
  </div>
  }
</div>

<!-- Filtros -->
@if (dbService.connected()) {
<div
  class="bg-white dark:bg-slate-800 p-3 md:p-4 rounded-xl shadow-sm border border-slate-100 dark:border-slate-700 mb-6">
  <div>
    <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">Buscar</label>
    <input type="text" placeholder="Buscar por RUC, razón social, contacto o email..."
      class="w-full px-3 py-2 border border-slate-300 dark:border-slate-600 rounded-lg focus:ring-2 focus:ring-primary-500 outline-none bg-white dark:bg-slate-700 text-slate-900 dark:text-white text-sm"
      [value]="busqueda()" (input)="cambiarBusqueda($any($event.target).value)">
  </div>
</div>
}

@if (dbService.connected()) {
@if(isLoading()) {
<div class="flex justify-center items-center p-8 bg-white dark:bg-slate-800 rounded-lg shadow-md">
  <svg class="animate-spin h-8 w-8 text-primary-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
    <path class="opacity-75" fill="currentColor"
      d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
    </path>
  </svg>
  <span class="ml-4 text-gray-600 dark:text-gray-300">Cargando clientes...</span>
</div>
} @else {
<div class="bg-white dark:bg-slate-800 rounded-lg shadow-md overflow-hidden">
  <!-- Vista Desktop: Tabla -->
  <div class="hidden md:block overflow-x-auto">
    <table class="w-full text-sm text-left text-gray-500 dark:text-gray-400">
      <thead class="text-xs text-gray-700 uppercase bg-slate-100 dark:bg-slate-700 dark:text-gray-400">
        <tr>
          <th scope="col" class="px-4 lg:px-6 py-3">RUC/Cédula</th>
          <th scope="col" class="px-4 lg:px-6 py-3">Razón Social</th>
          <th scope="col" class="px-4 lg:px-6 py-3">Contacto Principal</th>
          <th scope="col" class="px-4 lg:px-6 py-3">Email</th>
          <th scope="col" class="px-4 lg:px-6 py-3 text-center">Documentos</th>
          <th scope="col" class="px-4 lg:px-6 py-3 text-center">Acciones</th>
        </tr>
      </thead>
      <tbody>
        @for (client of clientesPaginados(); track client.id_cliente) {
        <tr class="bg-white border-b dark:bg-slate-800 dark:border-slate-700 hover:bg-slate-50 dark:hover:bg-slate-600">
          <td class="px-4 lg:px-6 py-3 font-medium text-gray-900 whitespace-nowrap dark:text-white">{{ client.ruc_cedula
            }}</td>
          <td class="px-4 lg:px-6 py-3">{{ client.nombre_razon_social }}</td>
          <td class="px-4 lg:px-6 py-3">{{ client.contacto_principal }}</td>
          <td class="px-4 lg:px-6 py-3 text-slate-600 dark:text-slate-400">{{ client.email }}</td>
          <td class="px-4 lg:px-6 py-3 text-center">
            <span
              class="px-3 py-1 bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-300 rounded-full text-xs font-semibold">
              {{ client.documentCount }}
            </span>
          </td>
          <td class="px-4 lg:px-6 py-3">
            <div class="flex items-center justify-center gap-2">
              <button (click)="verDetalleCliente(client)"
                class="text-primary-600 hover:text-primary-800 dark:text-primary-400 dark:hover:text-primary-300 transition-colors"
                title="Ver detalle">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                </svg>
              </button>
              <button (click)="abrirModalEditar(client)"
                class="text-blue-600 hover:text-blue-800 dark:text-blue-400 dark:hover:text-blue-300 transition-colors"
                title="Editar cliente">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                </svg>
              </button>
              <button (click)="eliminarCliente(client)"
                class="text-red-600 hover:text-red-800 dark:text-red-400 dark:hover:text-red-300 transition-colors"
                title="Eliminar cliente">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                </svg>
              </button>
            </div>
          </td>
        </tr>
        } @empty {
        <tr>
          <td colspan="6" class="text-center p-6 text-gray-500 dark:text-gray-400">
            @if (busqueda()) {
            No se encontraron clientes que coincidan con la búsqueda.
            } @else {
            No hay clientes registrados.
            }
          </td>
        </tr>
        }
      </tbody>
    </table>
  </div>

  <!-- Vista Mobile: Cards -->
  <div class="md:hidden space-y-4 p-4">
    @for (client of clientesPaginados(); track client.id_cliente) {
    <div class="bg-slate-50 dark:bg-slate-700 rounded-lg p-4 border border-slate-200 dark:border-slate-600">
      <div class="flex justify-between items-start mb-3">
        <div class="flex-1">
          <h3 class="font-semibold text-slate-900 dark:text-white text-base mb-1">{{ client.nombre_razon_social }}</h3>
          <p class="text-xs text-slate-600 dark:text-slate-400">{{ client.ruc_cedula }}</p>
        </div>
        <span
          class="px-3 py-1 bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-300 rounded-full text-xs font-semibold">
          {{ client.documentCount }} docs
        </span>
      </div>

      <div class="space-y-2 text-sm mb-3">
        <div class="flex items-center text-slate-700 dark:text-slate-300">
          <svg class="w-4 h-4 mr-2 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
          </svg>
          <span class="truncate">{{ client.contacto_principal }}</span>
        </div>
        <div class="flex items-center text-slate-700 dark:text-slate-300">
          <svg class="w-4 h-4 mr-2 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
          </svg>
          <span class="truncate">{{ client.email }}</span>
        </div>
      </div>

      <div class="flex justify-end gap-2 pt-3 border-t border-slate-200 dark:border-slate-600">
        <button (click)="verDetalleCliente(client)"
          class="px-3 py-1.5 text-xs font-medium text-primary-600 hover:text-primary-800 dark:text-primary-400 dark:hover:text-primary-300 bg-primary-50 dark:bg-primary-900/20 rounded-md flex items-center gap-1">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
          </svg>
          Detalle
        </button>
        <button (click)="abrirModalEditar(client)"
          class="px-3 py-1.5 text-xs font-medium text-blue-600 hover:text-blue-800 dark:text-blue-400 dark:hover:text-blue-300 bg-blue-50 dark:bg-blue-900/20 rounded-md">
          Editar
        </button>
        <button (click)="eliminarCliente(client)"
          class="px-3 py-1.5 text-xs font-medium text-red-600 hover:text-red-800 dark:text-red-400 dark:hover:text-red-300 bg-red-50 dark:bg-red-900/20 rounded-md">
          Eliminar
        </button>
      </div>
    </div>
    } @empty {
    <div class="text-center p-8 text-gray-500 dark:text-gray-400">
      @if (busqueda()) {
      No se encontraron clientes que coincidan con la búsqueda.
      } @else {
      No hay clientes registrados.
      }
    </div>
    }
  </div>

  <!-- Paginación -->
  @if (clientesFiltrados().length > 0) {
  <div class="border-t border-slate-200 dark:border-slate-700 bg-slate-50 dark:bg-slate-800/50 px-4 py-3">
    <!-- Desktop Pagination -->
    <div class="hidden md:flex items-center justify-between">
      <div class="text-sm text-slate-700 dark:text-slate-300">
        Mostrando <span class="font-semibold text-slate-800 dark:text-white">{{ (paginaActual() - 1) * itemsPorPagina()
          + 1 }}</span>
        a
        <span class="font-semibold text-slate-800 dark:text-white">{{ Math.min(paginaActual() * itemsPorPagina(),
          clientesFiltrados().length) }}</span>
        de
        <span class="font-semibold text-slate-800 dark:text-white">{{ clientesFiltrados().length }}</span>
        clientes
      </div>

      <div class="flex items-center gap-2">
        <button (click)="paginaAnterior()" [disabled]="paginaActual() === 1"
          class="px-3 py-2 text-sm font-medium text-slate-700 bg-white border border-slate-300 rounded-lg hover:bg-slate-50 disabled:opacity-50 disabled:cursor-not-allowed dark:bg-slate-700 dark:text-slate-300 dark:border-slate-600 dark:hover:bg-slate-600">
          Anterior
        </button>

        <div class="flex gap-1">
          @for (pagina of paginasArray(); track pagina) {
          @if (paginasArray().length <= 7 || pagina===1 || pagina===totalPaginas() || Math.abs(pagina - paginaActual())
            <=1) { <button (click)="cambiarPagina(pagina)"
            [class]="pagina === paginaActual() 
                        ? 'px-3 py-2 text-sm font-medium text-white bg-primary-600 border border-primary-600 rounded-lg hover:bg-primary-700' 
                        : 'px-3 py-2 text-sm font-medium text-slate-700 bg-white border border-slate-300 rounded-lg hover:bg-slate-50 dark:bg-slate-700 dark:text-slate-300 dark:border-slate-600 dark:hover:bg-slate-600'">
            {{ pagina }}
            </button>
            } @else if (pagina === 2 || pagina === totalPaginas() - 1) {
            <span class="px-2 py-2 text-slate-500">...</span>
            }
            }
        </div>

        <button (click)="paginaSiguiente()" [disabled]="paginaActual() === totalPaginas()"
          class="px-3 py-2 text-sm font-medium text-slate-700 bg-white border border-slate-300 rounded-lg hover:bg-slate-50 disabled:opacity-50 disabled:cursor-not-allowed dark:bg-slate-700 dark:text-slate-300 dark:border-slate-600 dark:hover:bg-slate-600">
          Siguiente
        </button>
      </div>
    </div>

    <!-- Mobile Pagination -->
    <div class="md:hidden flex items-center justify-between">
      <button (click)="paginaAnterior()" [disabled]="paginaActual() === 1"
        class="px-3 py-2 text-sm font-medium text-slate-700 bg-white border border-slate-300 rounded-lg hover:bg-slate-50 disabled:opacity-50 disabled:cursor-not-allowed dark:bg-slate-700 dark:text-slate-300 dark:border-slate-600">
        Anterior
      </button>

      <span class="text-sm text-slate-700 dark:text-slate-300">
        {{ paginaActual() }} / {{ totalPaginas() }}
      </span>

      <button (click)="paginaSiguiente()" [disabled]="paginaActual() === totalPaginas()"
        class="px-3 py-2 text-sm font-medium text-slate-700 bg-white border border-slate-300 rounded-lg hover:bg-slate-50 disabled:opacity-50 disabled:cursor-not-allowed dark:bg-slate-700 dark:text-slate-300 dark:border-slate-600">
        Siguiente
      </button>
    </div>
  </div>
  }
</div>
}
} @else {
<div class="bg-white dark:bg-slate-800 rounded-lg shadow-md p-6 text-center">
  <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
    <path vector-effect="non-scaling-stroke" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
      d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
  </svg>
  <h3 class="mt-2 text-lg font-medium text-gray-900 dark:text-white">Conexión Requerida</h3>
  <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">Por favor, conéctese a la base de datos en la sección de
    'Ajustes de BD' para ver los archivos de clientes.</p>
</div>
}

<!-- Modal Nuevo Cliente -->
@if (mostrarModalNuevoCliente()) {
<div
  class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50 flex items-center justify-center p-2 md:p-4">
  <div class="relative bg-white dark:bg-slate-800 rounded-lg shadow-xl w-full max-w-2xl max-h-[90vh] overflow-y-auto">
    <!-- Header -->
    <div
      class="flex items-center justify-between p-4 md:p-6 border-b dark:border-slate-700 sticky top-0 bg-white dark:bg-slate-800 z-10">
      <h3 class="text-lg md:text-xl font-semibold text-gray-900 dark:text-white">
        Añadir Nuevo Cliente
      </h3>
      <button (click)="cerrarModalNuevoCliente()" type="button"
        class="text-gray-400 bg-transparent hover:bg-gray-200 hover:text-gray-900 rounded-lg text-sm p-1.5 ml-auto inline-flex items-center dark:hover:bg-slate-600 dark:hover:text-white">
        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
          <path fill-rule="evenodd"
            d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z"
            clip-rule="evenodd"></path>
        </svg>
      </button>
    </div>

    <!-- Body -->
    <div class="p-4 md:p-6 space-y-4">
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <!-- RUC/Cédula -->
        <div>
          <label for="ruc_cedula" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">
            RUC/Cédula <span class="text-red-500">*</span>
          </label>
          <input type="text" id="ruc_cedula" [(ngModel)]="nuevoCliente.ruc_cedula"
            class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-500 focus:border-primary-500 block w-full p-2.5 dark:bg-slate-700 dark:border-slate-600 dark:placeholder-gray-400 dark:text-white"
            placeholder="0999999999001" required>
        </div>

        <!-- Razón Social -->
        <div>
          <label for="nombre_razon_social" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">
            Razón Social <span class="text-red-500">*</span>
          </label>
          <input type="text" id="nombre_razon_social" [(ngModel)]="nuevoCliente.nombre_razon_social"
            class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-500 focus:border-primary-500 block w-full p-2.5 dark:bg-slate-700 dark:border-slate-600 dark:placeholder-gray-400 dark:text-white"
            placeholder="Empresa S.A." required>
        </div>

        <!-- Dirección -->
        <div class="md:col-span-2">
          <label for="direccion" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">
            Dirección <span class="text-red-500">*</span>
          </label>
          <input type="text" id="direccion" [(ngModel)]="nuevoCliente.direccion"
            class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-500 focus:border-primary-500 block w-full p-2.5 dark:bg-slate-700 dark:border-slate-600 dark:placeholder-gray-400 dark:text-white"
            placeholder="Av. Principal 123" required>
        </div>

        <!-- Teléfono -->
        <div>
          <label for="telefono" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">
            Teléfono <span class="text-red-500">*</span>
          </label>
          <input type="tel" id="telefono" [(ngModel)]="nuevoCliente.telefono"
            class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-500 focus:border-primary-500 block w-full p-2.5 dark:bg-slate-700 dark:border-slate-600 dark:placeholder-gray-400 dark:text-white"
            placeholder="0999999999" required>
        </div>

        <!-- Email -->
        <div>
          <label for="email" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">
            Email <span class="text-red-500">*</span>
          </label>
          <input type="email" id="email" [(ngModel)]="nuevoCliente.email"
            class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-500 focus:border-primary-500 block w-full p-2.5 dark:bg-slate-700 dark:border-slate-600 dark:placeholder-gray-400 dark:text-white"
            placeholder="contacto@empresa.com" required>
        </div>

        <!-- Contacto Principal -->
        <div class="md:col-span-2">
          <label for="contacto_principal" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">
            Contacto Principal <span class="text-red-500">*</span>
          </label>
          <input type="text" id="contacto_principal" [(ngModel)]="nuevoCliente.contacto_principal"
            class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-500 focus:border-primary-500 block w-full p-2.5 dark:bg-slate-700 dark:border-slate-600 dark:placeholder-gray-400 dark:text-white"
            placeholder="Juan Pérez" required>
        </div>

        <!-- Contactos Adicionales -->
        <div class="md:col-span-2 border-t pt-4 dark:border-slate-700">
          <label class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">
            Contactos Adicionales
          </label>

          <!-- Lista de Contactos Temporales -->
          <div class="space-y-2 mb-3">
            @for (contacto of nuevoCliente.contactos_adicionales; track $index) {
            <div
              class="flex items-center justify-between p-3 bg-gray-50 dark:bg-slate-700/50 rounded border border-slate-200 dark:border-slate-600">
              <span class="text-sm font-medium text-slate-900 dark:text-white">{{ contacto.nombre_completo }}</span>
              <button type="button" (click)="removerContactoTemporal('nuevo', $index)"
                class="text-red-600 hover:text-red-800 p-1" title="Eliminar contacto">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                </svg>
              </button>
            </div>
            }
            @if (nuevoCliente.contactos_adicionales.length === 0) {
            <p class="text-xs text-gray-500 italic">No hay contactos adicionales agregados.</p>
            }
          </div>

          <!-- Input para agregar contacto -->
          <div class="flex gap-2">
            <div class="flex-1 space-y-2">
              <input type="text" [(ngModel)]="nuevoContactoTemporal.nombre_completo" placeholder="Nombre completo *"
                class="w-full bg-white border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-500 focus:border-primary-500 block p-2.5 dark:bg-slate-800 dark:border-slate-600 dark:placeholder-gray-400 dark:text-white">
              <input type="email" [(ngModel)]="nuevoContactoTemporal.email" placeholder="Email *"
                class="w-full bg-white border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-500 focus:border-primary-500 block p-2.5 dark:bg-slate-800 dark:border-slate-600 dark:placeholder-gray-400 dark:text-white">
              <input type="tel" [(ngModel)]="nuevoContactoTemporal.telefono" placeholder="Teléfono"
                class="w-full bg-white border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-500 focus:border-primary-500 block p-2.5 dark:bg-slate-800 dark:border-slate-600 dark:placeholder-gray-400 dark:text-white">
            </div>
            <button type="button" (click)="agregarContactoTemporal('nuevo')" [disabled]="!nombreNuevoContacto.trim()"
              class="px-4 py-2 bg-primary-600 text-white rounded-lg hover:bg-primary-700 disabled:opacity-50 disabled:cursor-not-allowed flex items-center">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
              </svg>
            </button>
          </div>
        </div>
      </div>
    </div>
    <!-- Footer -->
    <div
      class="flex items-center justify-end gap-2 p-4 md:p-6 border-t dark:border-slate-700 bg-gray-50 dark:bg-slate-800/50 sticky bottom-0">
      <button (click)="cerrarModalNuevoCliente()" type="button"
        class="px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500 dark:bg-slate-700 dark:text-gray-300 dark:border-slate-600 dark:hover:bg-slate-600">
        Cancelar
      </button>
      <button (click)="guardarNuevoCliente()" type="button"
        [disabled]="!formularioClienteValido() || guardandoCliente()"
        class="px-4 py-2 text-sm font-medium text-white bg-primary-600 rounded-lg hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500 disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-2">
        @if (guardandoCliente()) {
        <svg class="animate-spin h-4 w-4 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
          <path class="opacity-75" fill="currentColor"
            d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
          </path>
        </svg>
        <span>Guardando...</span>
        } @else {
        <span>Guardar Cliente</span>
        }
      </button>
    </div>
  </div>
</div>
}

<!-- Modal Detalle Cliente -->
@if (mostrarModalDetalle() && clienteDetalle()) {
<div
  class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50 flex items-center justify-center p-2 md:p-4">
  <div class="relative bg-white dark:bg-slate-800 rounded-lg shadow-xl w-full max-w-3xl max-h-[90vh] overflow-y-auto">
    <!-- Header -->
    <div
      class="flex items-center justify-between p-4 md:p-6 border-b dark:border-slate-700 sticky top-0 bg-white dark:bg-slate-800 z-10">
      <h3 class="text-lg md:text-xl font-semibold text-gray-900 dark:text-white">
        Detalle del Cliente
      </h3>
      <button (click)="cerrarModalDetalle()" type="button"
        class="text-gray-400 bg-transparent hover:bg-gray-200 hover:text-gray-900 rounded-lg text-sm p-1.5 ml-auto inline-flex items-center dark:hover:bg-slate-600 dark:hover:text-white">
        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
          <path fill-rule="evenodd"
            d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z"
            clip-rule="evenodd"></path>
        </svg>
      </button>
    </div>

    <!-- Body -->
    <div class="p-4 md:p-6 space-y-6">
      <!-- Información Principal -->
      <div class="bg-slate-50 dark:bg-slate-700/50 rounded-lg p-4">
        <h4 class="text-sm font-semibold text-slate-900 dark:text-white mb-3 flex items-center">
          <svg class="w-5 h-5 mr-2 text-primary-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" />
          </svg>
          Información del Cliente
        </h4>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="block text-xs font-medium text-slate-500 dark:text-slate-400 mb-1">RUC/Cédula</label>
            <p class="text-sm font-semibold text-slate-900 dark:text-white">{{ clienteDetalle()!.ruc_cedula }}</p>
          </div>
          <div>
            <label class="block text-xs font-medium text-slate-500 dark:text-slate-400 mb-1">Razón Social</label>
            <p class="text-sm font-semibold text-slate-900 dark:text-white">{{ clienteDetalle()!.nombre_razon_social }}
            </p>
          </div>
          <div class="md:col-span-2">
            <label class="block text-xs font-medium text-slate-500 dark:text-slate-400 mb-1">Dirección</label>
            <p class="text-sm text-slate-700 dark:text-slate-300">{{ clienteDetalle()!['direccion'] || 'No disponible'
              }}</p>
          </div>
        </div>
      </div>

      <!-- Información de Contacto -->
      <div class="bg-slate-50 dark:bg-slate-700/50 rounded-lg p-4">
        <h4 class="text-sm font-semibold text-slate-900 dark:text-white mb-3 flex items-center">
          <svg class="w-5 h-5 mr-2 text-primary-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
          </svg>
          Información de Contacto
        </h4>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="block text-xs font-medium text-slate-500 dark:text-slate-400 mb-1">Contacto Principal</label>
            <p class="text-sm text-slate-700 dark:text-slate-300">{{ clienteDetalle()!.contacto_principal }}</p>
          </div>
          <div>
            <label class="block text-xs font-medium text-slate-500 dark:text-slate-400 mb-1">Teléfono</label>
            <p class="text-sm text-slate-700 dark:text-slate-300">{{ clienteDetalle()!['telefono'] || 'No disponible' }}
            </p>
          </div>
          <div class="md:col-span-2">
            <label class="block text-xs font-medium text-slate-500 dark:text-slate-400 mb-1">Email</label>
            <p class="text-sm text-slate-700 dark:text-slate-300">{{ clienteDetalle()!.email }}</p>
          </div>
        </div>
      </div>

      <!-- Contactos Adicionales -->
      <div class="bg-slate-50 dark:bg-slate-700/50 rounded-lg p-4">
        <h4 class="text-sm font-semibold text-slate-900 dark:text-white mb-3 flex items-center">
          <svg class="w-5 h-5 mr-2 text-primary-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" />
          </svg>
          Contactos Adicionales
        </h4>

        <!-- Lista de Contactos -->
        <div class="space-y-3 mb-4">
          @for (contacto of contactosCliente(); track contacto.id_contacto) {
          <div class="bg-white dark:bg-slate-800 rounded border border-slate-200 dark:border-slate-600 p-3">
            @if (editingContactId() === contacto.id_contacto) {
              <!-- Modo Edición -->
              <div class="space-y-2">
                <input type="text" [(ngModel)]="editingContactData()!.nombre_completo"
                  placeholder="Nombre completo *"
                  class="w-full bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-500 focus:border-primary-500 block p-2 dark:bg-slate-700 dark:border-slate-600 dark:text-white">
                <input type="email" [(ngModel)]="editingContactData()!.email"
                  placeholder="Email *"
                  class="w-full bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-500 focus:border-primary-500 block p-2 dark:bg-slate-700 dark:border-slate-600 dark:text-white">
                <input type="tel" [(ngModel)]="editingContactData()!.telefono"
                  placeholder="Teléfono"
                  class="w-full bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-500 focus:border-primary-500 block p-2 dark:bg-slate-700 dark:border-slate-600 dark:text-white">
                <div class="flex gap-2 justify-end pt-2">
                  <button (click)="cancelarEdicionContacto()"
                    class="px-3 py-1.5 text-xs font-medium text-gray-700 bg-white border border-gray-300 rounded-md hover:bg-gray-50 dark:bg-slate-700 dark:text-gray-300 dark:border-slate-600">
                    Cancelar
                  </button>
                  <button (click)="guardarEdicionContacto(contacto.id_contacto)" [disabled]="savingContact()"
                    class="px-3 py-1.5 text-xs font-medium text-white bg-primary-600 rounded-md hover:bg-primary-700 disabled:opacity-50 flex items-center gap-1">
                    @if (savingContact()) {
                      <svg class="animate-spin h-3 w-3" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                      </svg>
                    }
                    Guardar
                  </button>
                </div>
              </div>
            } @else {
              <!-- Modo Vista -->
              <div class="flex items-start justify-between">
                <div class="flex-1">
                  <p class="text-sm font-medium text-slate-900 dark:text-white flex items-center gap-2">
                    {{ contacto.nombre_completo }}
                    @if (contacto.es_principal == 1) {
                      <span class="text-xs bg-green-100 text-green-800 px-2 py-0.5 rounded-full">Principal</span>
                    }
                  </p>
                  @if (contacto.email) {
                    <p class="text-xs text-slate-600 dark:text-slate-400 mt-1 flex items-center gap-1">
                      <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
                      </svg>
                      {{ contacto.email }}
                    </p>
                  }
                  @if (contacto.telefono) {
                    <p class="text-xs text-slate-600 dark:text-slate-400 mt-1 flex items-center gap-1">
                      <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z" />
                      </svg>
                      {{ contacto.telefono }}
                    </p>
                  }
                </div>
                <div class="flex gap-1 ml-2">
                  @if (contacto.es_principal != 1) {
                    <button (click)="marcarComoPrincipal(contacto)" [disabled]="settingPrincipal()"
                      class="p-1.5 text-green-600 hover:text-green-800 hover:bg-green-50 rounded dark:text-green-400 dark:hover:bg-green-900/20 disabled:opacity-50"
                      title="Marcar como principal">
                      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                      </svg>
                    </button>
                  }
                  <button (click)="editarContacto(contacto)"
                    class="p-1.5 text-blue-600 hover:text-blue-800 hover:bg-blue-50 rounded dark:text-blue-400 dark:hover:bg-blue-900/20"
                    title="Editar contacto">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                    </svg>
                  </button>
                  <button (click)="eliminarContacto(contacto)"
                    class="p-1.5 text-red-600 hover:text-red-800 hover:bg-red-50 rounded dark:text-red-400 dark:hover:bg-red-900/20"
                    title="Eliminar contacto">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                    </svg>
                  </button>
                </div>
              </div>
            }
          </div>
          }
          @if (contactosCliente().length === 0 && !cargandoContactos()) {
          <p class="text-sm text-slate-500 italic">No hay contactos adicionales registrados.</p>
          }
        </div>

        <!-- Formulario Nuevo Contacto -->
        <div class="flex gap-2">
          <div class="flex-1 space-y-2">
            <input type="text" [(ngModel)]="nuevoContacto.nombre_completo" placeholder="Nombre completo *"
              class="w-full bg-white border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-500 focus:border-primary-500 block p-2.5 dark:bg-slate-800 dark:border-slate-600 dark:placeholder-gray-400 dark:text-white">
            <input type="email" [(ngModel)]="nuevoContacto.email" placeholder="Email *"
              class="w-full bg-white border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-500 focus:border-primary-500 block p-2.5 dark:bg-slate-800 dark:border-slate-600 dark:placeholder-gray-400 dark:text-white">
            <input type="tel" [(ngModel)]="nuevoContacto.telefono" placeholder="Teléfono"
              class="w-full bg-white border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-500 focus:border-primary-500 block p-2.5 dark:bg-slate-800 dark:border-slate-600 dark:placeholder-gray-400 dark:text-white">
          </div>
          <button (click)="guardarContacto()" [disabled]="!nuevoContacto.nombre_completo.trim() || agregandoContacto()"
            class="px-4 py-2 bg-primary-600 text-white rounded-lg hover:bg-primary-700 disabled:opacity-50 disabled:cursor-not-allowed flex items-center">
            @if (agregandoContacto()) {
            <svg class="animate-spin h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
              <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
              <path class="opacity-75" fill="currentColor"
                d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
              </path>
            </svg>
            } @else {
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
            </svg>
            }
          </button>
        </div>
      </div>

      <!-- Estadísticas de Documentos -->
      <div
        class="bg-blue-50 dark:bg-blue-900/20 rounded-lg p-4 border border-blue-200 dark:border-blue-800 cursor-pointer hover:bg-blue-100 dark:hover:bg-blue-900/30 transition-colors"
        (click)="toggleDocumentos()">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-xs font-medium text-blue-600 dark:text-blue-400 mb-1">Total de Documentos</p>
            <p class="text-2xl font-bold text-blue-900 dark:text-blue-100">{{ documentosCliente().length }}</p>
          </div>
          <div class="relative">
            <div
              class="p-3 bg-blue-100 dark:bg-blue-800/50 rounded-full hover:bg-blue-200 dark:hover:bg-blue-800 transition-colors">
              <svg class="w-8 h-8 text-blue-600 dark:text-blue-300" fill="none" stroke="currentColor"
                viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                  d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z" />
              </svg>
            </div>
            @if (documentosCliente().length > 0) {
            <div class="absolute -top-1 -right-1 w-5 h-5 bg-red-500 rounded-full flex items-center justify-center">
              <span class="text-white text-xs font-bold">{{ documentosCliente().length }}</span>
            </div>
            }
          </div>
        </div>
        <div class="mt-2 text-xs text-blue-600 dark:text-blue-400 flex items-center justify-center">
          @if (mostrarDocumentos()) {
          <span class="flex items-center">
            <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7" />
            </svg>
            Click para ocultar documentos
          </span>
          } @else {
          <span class="flex items-center">
            <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
            </svg>
            Click para ver documentos
          </span>
          }
        </div>
      </div>

      <!-- Lista de Documentos (Solo visible cuando mostrarDocumentos es true) -->
      @if (mostrarDocumentos()) {
      <div class="bg-slate-50 dark:bg-slate-700/50 rounded-lg p-4">
        <h4 class="text-sm font-semibold text-slate-900 dark:text-white mb-3 flex items-center">
          <svg class="w-5 h-5 mr-2 text-primary-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
          </svg>
          Documentos del Cliente
        </h4>

        @if (cargandoDocumentos()) {
        <div class="flex justify-center items-center py-8">
          <svg class="animate-spin h-6 w-6 text-primary-500" xmlns="http://www.w3.org/2000/svg" fill="none"
            viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor"
              d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
            </path>
          </svg>
          <span class="ml-3 text-slate-600 dark:text-slate-400">Cargando documentos...</span>
        </div>
        } @else if (documentosCliente().length === 0) {
        <div class="text-center py-8 text-slate-500 dark:text-slate-400">
          <svg class="w-16 h-16 mx-auto mb-3 text-slate-400 dark:text-slate-500" fill="none" stroke="currentColor"
            viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
          </svg>
          <p class="text-sm">No hay documentos registrados para este cliente</p>
        </div>
        } @else {
        <!-- Desktop: Tabla de documentos -->
        <div class="hidden md:block overflow-x-auto">
          <table class="w-full text-xs">
            <thead class="text-xs text-slate-700 uppercase bg-slate-100 dark:bg-slate-600 dark:text-slate-300">
              <tr>
                <th class="px-3 py-2 text-left">Tipo</th>
                <th class="px-3 py-2 text-left">Número</th>
                <th class="px-3 py-2 text-left">Nombre Archivo</th>
                <th class="px-3 py-2 text-left">Fecha</th>
                <th class="px-3 py-2 text-left">OT</th>
              </tr>
            </thead>
            <tbody>
              @for (doc of documentosCliente(); track doc.id_archivo) {
              <tr class="border-b dark:border-slate-600 hover:bg-slate-100 dark:hover:bg-slate-600">
                <td class="px-3 py-2">
                  <span
                    class="px-2 py-1 bg-primary-100 text-primary-800 dark:bg-primary-900 dark:text-primary-300 rounded text-xs">
                    {{ doc.tipo_documento }}
                  </span>
                </td>
                <td class="px-3 py-2 text-slate-700 dark:text-slate-300">{{ doc.numero_secuencial }}</td>
                <td class="px-3 py-2 text-slate-700 dark:text-slate-300 truncate max-w-xs" [title]="doc.nombre_archivo">
                  {{ doc.nombre_archivo }}
                </td>
                <td class="px-3 py-2 text-slate-600 dark:text-slate-400">
                  {{ doc.fecha_subida | date:'dd/MM/yyyy' }}
                </td>
                <td class="px-3 py-2 text-slate-600 dark:text-slate-400">
                  {{ doc.id_ot || '-' }}
                </td>
              </tr>
              }
            </tbody>
          </table>
        </div>

        <!-- Mobile: Cards de documentos -->
        <div class="md:hidden space-y-3">
          @for (doc of documentosCliente(); track doc.id_archivo) {
          <div class="bg-white dark:bg-slate-600 rounded-lg p-3 border border-slate-200 dark:border-slate-500">
            <div class="flex justify-between items-start mb-2">
              <span
                class="px-2 py-1 bg-primary-100 text-primary-800 dark:bg-primary-900 dark:text-primary-300 rounded text-xs font-medium">
                {{ doc.tipo_documento }}
              </span>
              <span class="text-xs text-slate-500 dark:text-slate-400">
                {{ doc.fecha_subida | date:'dd/MM/yy' }}
              </span>
            </div>
            <p class="text-sm font-medium text-slate-900 dark:text-white mb-1">
              {{ doc.numero_secuencial }}
            </p>
            <p class="text-xs text-slate-600 dark:text-slate-400 truncate" [title]="doc.nombre_archivo">
              {{ doc.nombre_archivo }}
            </p>
            @if (doc.id_ot) {
            <p class="text-xs text-slate-500 dark:text-slate-400 mt-2">
              OT: {{ doc.id_ot }}
            </p>
            }
          </div>
          }
        </div>
        }
      </div>
      }
    </div>

    <!-- Footer -->
    <div
      class="flex items-center justify-end gap-2 p-4 md:p-6 border-t dark:border-slate-700 bg-gray-50 dark:bg-slate-800/50 sticky bottom-0">
      <button (click)="cerrarModalDetalle()" type="button"
        class="px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500 dark:bg-slate-700 dark:text-gray-300 dark:border-slate-600 dark:hover:bg-slate-600">
        Cerrar
      </button>
    </div>
  </div>
</div>
}

<!-- Modal Editar Cliente -->
@if (mostrarModalEditar() && clienteEditar()) {
<div
  class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50 flex items-center justify-center p-2 md:p-4">
  <div class="relative bg-white dark:bg-slate-800 rounded-lg shadow-xl w-full max-w-2xl max-h-[90vh] overflow-y-auto">
    <!-- Header -->
    <div
      class="flex items-center justify-between p-4 md:p-6 border-b dark:border-slate-700 sticky top-0 bg-white dark:bg-slate-800 z-10">
      <h3 class="text-lg md:text-xl font-semibold text-gray-900 dark:text-white">
        Editar Cliente
      </h3>
      <button (click)="cerrarModalEditar()" type="button"
        class="text-gray-400 bg-transparent hover:bg-gray-200 hover:text-gray-900 rounded-lg text-sm p-1.5 ml-auto inline-flex items-center dark:hover:bg-slate-600 dark:hover:text-white">
        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
          <path fill-rule="evenodd"
            d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z"
            clip-rule="evenodd"></path>
        </svg>
      </button>
    </div>

    <!-- Body -->
    <div class="p-4 md:p-6 space-y-4">
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <!-- RUC/Cédula -->
        <div>
          <label for="edit_ruc_cedula" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">
            RUC/Cédula <span class="text-red-500">*</span>
          </label>
          <input type="text" id="edit_ruc_cedula" [(ngModel)]="clienteEditar()!.ruc_cedula"
            class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-500 focus:border-primary-500 block w-full p-2.5 dark:bg-slate-700 dark:border-slate-600 dark:placeholder-gray-400 dark:text-white"
            required>
        </div>

        <!-- Razón Social -->
        <div>
          <label for="edit_nombre_razon_social" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">
            Razón Social <span class="text-red-500">*</span>
          </label>
          <input type="text" id="edit_nombre_razon_social" [(ngModel)]="clienteEditar()!.nombre_razon_social"
            class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-500 focus:border-primary-500 block w-full p-2.5 dark:bg-slate-700 dark:border-slate-600 dark:placeholder-gray-400 dark:text-white"
            required>
        </div>

        <!-- Dirección -->
        <div class="md:col-span-2">
          <label for="edit_direccion" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">
            Dirección <span class="text-red-500">*</span>
          </label>
          <input type="text" id="edit_direccion" [(ngModel)]="clienteEditar()!.direccion"
            class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-500 focus:border-primary-500 block w-full p-2.5 dark:bg-slate-700 dark:border-slate-600 dark:placeholder-gray-400 dark:text-white"
            required>
        </div>

        <!-- Teléfono -->
        <div>
          <label for="edit_telefono" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">
            Teléfono <span class="text-red-500">*</span>
          </label>
          <input type="tel" id="edit_telefono" [(ngModel)]="clienteEditar()!.telefono"
            class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-500 focus:border-primary-500 block w-full p-2.5 dark:bg-slate-700 dark:border-slate-600 dark:placeholder-gray-400 dark:text-white"
            required>
        </div>

        <!-- Email -->
        <div>
          <label for="edit_email" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">
            Email <span class="text-red-500">*</span>
          </label>
          <input type="email" id="edit_email" [(ngModel)]="clienteEditar()!.email"
            class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-500 focus:border-primary-500 block w-full p-2.5 dark:bg-slate-700 dark:border-slate-600 dark:placeholder-gray-400 dark:text-white"
            required>
        </div>

        <!-- Contacto Principal -->
        <div class="md:col-span-2">
          <label for="edit_contacto_principal" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">
            Contacto Principal <span class="text-red-500">*</span>
          </label>
          <input type="text" id="edit_contacto_principal" [(ngModel)]="clienteEditar()!.contacto_principal"
            class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-500 focus:border-primary-500 block w-full p-2.5 dark:bg-slate-700 dark:border-slate-600 dark:placeholder-gray-400 dark:text-white"
            required>
        </div>

        <!-- Contactos Adicionales -->
        <div class="md:col-span-2 border-t pt-4 dark:border-slate-700">
          <label class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">
            Contactos Adicionales
          </label>

          <!-- Lista de Contactos Temporales -->
          <div class="space-y-2 mb-3">
            @for (contacto of clienteEditar()!.contactos_adicionales; track $index) {
            <div
              class="flex items-center justify-between p-3 bg-gray-50 dark:bg-slate-700/50 rounded border border-slate-200 dark:border-slate-600">
              <span class="text-sm font-medium text-slate-900 dark:text-white">{{ contacto.nombre_completo }}</span>
              <button type="button" (click)="removerContactoTemporal('editar', $index)"
                class="text-red-600 hover:text-red-800 p-1" title="Eliminar contacto">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                </svg>
              </button>
            </div>
            }
            @if (!clienteEditar()?.contactos_adicionales?.length) {
            <p class="text-xs text-gray-500 italic">No hay contactos adicionales agregados.</p>
            }
          </div>

          <!-- Input para agregar contacto -->
          <div class="flex gap-2">
            <div class="flex-1 space-y-2">
              <input type="text" [(ngModel)]="nuevoContactoTemporal.nombre_completo" placeholder="Nombre completo *"
                class="w-full bg-white border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-500 focus:border-primary-500 block p-2.5 dark:bg-slate-800 dark:border-slate-600 dark:placeholder-gray-400 dark:text-white">
              <input type="email" [(ngModel)]="nuevoContactoTemporal.email" placeholder="Email *"
                class="w-full bg-white border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-500 focus:border-primary-500 block p-2.5 dark:bg-slate-800 dark:border-slate-600 dark:placeholder-gray-400 dark:text-white">
              <input type="tel" [(ngModel)]="nuevoContactoTemporal.telefono" placeholder="Teléfono"
                class="w-full bg-white border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-500 focus:border-primary-500 block p-2.5 dark:bg-slate-800 dark:border-slate-600 dark:placeholder-gray-400 dark:text-white">
            </div>
            <button type="button" (click)="agregarContactoTemporal('editar')" [disabled]="!nombreNuevoContacto.trim()"
              class="px-4 py-2 bg-primary-600 text-white rounded-lg hover:bg-primary-700 disabled:opacity-50 disabled:cursor-not-allowed flex items-center">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
              </svg>
            </button>
          </div>
        </div>
      </div>
    </div>
    <!-- Footer -->
    <div
      class="flex items-center justify-end gap-2 p-4 md:p-6 border-t dark:border-slate-700 bg-gray-50 dark:bg-slate-800/50 sticky bottom-0">
      <button (click)="cerrarModalEditar()" type="button"
        class="px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500 dark:bg-slate-700 dark:text-gray-300 dark:border-slate-600 dark:hover:bg-slate-600">
        Cancelar
      </button>
      <button (click)="guardarEdicionCliente()" type="button" [disabled]="guardandoCliente()"
        class="px-4 py-2 text-sm font-medium text-white bg-primary-600 rounded-lg hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500 disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-2">
        @if (guardandoCliente()) {
        <svg class="animate-spin h-4 w-4 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
          <path class="opacity-75" fill="currentColor"
            d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
          </path>
        </svg>
        <span>Guardando...</span>
        } @else {
        <span>Guardar Cambios</span>
        }
      </button>
    </div>
  </div>
</div>
}

<!-- ============================================ -->
<!-- MODAL: Confirmar Eliminación -->
<!-- ============================================ -->
@if (showDeleteModal()) {
<div class="fixed inset-0 z-50 overflow-y-auto" aria-labelledby="modal-title" role="dialog" aria-modal="true">
  <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
    <!-- Background overlay -->
    <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" aria-hidden="true"
      (click)="closeDeleteModal()"></div>

    <!-- Center modal -->
    <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>

    <div
      class="inline-block align-bottom bg-white dark:bg-gray-800 rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
      <div class="bg-white dark:bg-gray-800 px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
        <div class="sm:flex sm:items-start">
          <div
            class="mx-auto flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-full bg-red-100 sm:mx-0 sm:h-10 sm:w-10">
            <!-- Warning Icon -->
            <svg class="h-6 w-6 text-red-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
              stroke="currentColor" aria-hidden="true">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
            </svg>
          </div>
          <div class="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left">
            <h3 class="text-lg leading-6 font-medium text-gray-900 dark:text-white" id="modal-title">Eliminar Cliente
            </h3>
            <div class="mt-2">
              <p class="text-sm text-gray-500 dark:text-gray-300">
                ¿Está seguro de que desea eliminar al cliente <span class="font-bold">{{
                  clientToDelete()?.nombre_razon_social }}</span>?
              </p>
              <p class="text-xs text-gray-400 dark:text-gray-500 mt-1">
                RUC: {{ clientToDelete()?.ruc_cedula }}
              </p>
              <p class="text-sm text-gray-500 dark:text-gray-300 mt-2">
                Esta acción no se puede deshacer.
              </p>
            </div>
          </div>
        </div>
      </div>
      <div class="bg-gray-50 dark:bg-gray-700 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
        <button type="button" (click)="confirmDelete()"
          class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-red-600 text-base font-medium text-white hover:bg-red-700 focus:outline-none sm:ml-3 sm:w-auto sm:text-sm">
          Eliminar
        </button>
        <button type="button" (click)="closeDeleteModal()"
          class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm">
          Cancelar
        </button>
      </div>
    </div>
  </div>
</div>
}


<!-- Modal Confirmación Marcar como Principal -->
@if (showSetPrincipalModal()) {
<div class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50 flex items-center justify-center">
  <div class="relative bg-white dark:bg-slate-800 rounded-lg shadow-xl max-w-md w-full mx-4">
    <div class="p-6">
      <div class="flex items-center mb-4">
        <div class="flex-shrink-0 w-12 h-12 rounded-full bg-green-100 dark:bg-green-900/30 flex items-center justify-center">
          <svg class="w-6 h-6 text-green-600 dark:text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
          </svg>
        </div>
        <div class="ml-4">
          <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Marcar como Principal</h3>
        </div>
      </div>
      
      <p class="text-sm text-gray-600 dark:text-gray-300 mb-6">
        ¿Está seguro de marcar a <strong class="text-gray-900 dark:text-white">{{ contactToSetPrincipal()?.nombre_completo }}</strong> como contacto principal?
        <br><br>
        <span class="text-gray-500 dark:text-gray-400">El contacto principal actual será cambiado a contacto adicional.</span>
      </p>
      
      <div class="flex gap-3 justify-end">
        <button (click)="closeSetPrincipalModal()"
          class="px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md hover:bg-gray-50 dark:bg-slate-700 dark:text-gray-300 dark:border-slate-600 dark:hover:bg-slate-600">
          Cancelar
        </button>
        <button (click)="confirmSetPrincipal()"
          class="px-4 py-2 text-sm font-medium text-white bg-green-600 rounded-md hover:bg-green-700 flex items-center gap-2">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
          </svg>
          Marcar como Principal
        </button>
      </div>
    </div>
  </div>
</div>
}

<!-- Modal Confirmación Eliminar Contacto -->
@if (showDeleteContactModal()) {
<app-confirm-delete-modal [isOpen]="showDeleteContactModal()"
  [itemName]="contactToDelete()?.nombre_completo || 'este contacto'" itemType="contacto"
  (onConfirm)="confirmDeleteContact()" (onCancel)="closeDeleteContactModal()">
</app-confirm-delete-modal>
}